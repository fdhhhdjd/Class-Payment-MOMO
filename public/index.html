<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>MoMo Demo - Code Web Không Khó</title>
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="branding-header">
      <div class="brand-left">
          <div class="logo-wrapper">
              <img src="/logo.jpg" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/60x60?text=CWKK'">
              <div class="verified-badge">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5213 2.62368C11.3147 1.75255 12.6853 1.75255 13.4787 2.62368L14.4989 3.74391C14.8326 4.11033 15.3059 4.30634 15.8039 4.28489L17.3254 4.21933C18.5108 4.16824 19.5103 5.16776 19.4592 6.35315L19.3936 7.87463C19.3721 8.37265 19.5681 8.84591 19.9345 9.17957L21.0548 10.1998C21.9259 10.9932 21.9259 12.3638 21.0548 13.1572L19.9345 14.1775C19.5681 14.5111 19.3721 14.9844 19.3936 15.4824L19.4592 17.0039C19.5103 18.1893 18.5108 19.1888 17.3254 19.1377L15.8039 19.0721C15.3059 19.0507 14.8326 19.2467 14.4989 19.6131L13.4787 20.7334C12.6853 21.6045 11.3147 21.6045 10.5213 20.7334L9.50111 19.6131C9.16745 19.2467 8.69419 19.0507 8.19617 19.0721L6.67469 19.1377C5.4893 19.1888 4.48978 18.1893 4.54087 17.0039L4.60643 15.4824C4.62788 14.9844 4.43187 14.5111 4.06545 14.1775L2.9452 13.1572C2.07407 12.3638 2.07407 10.9932 2.9452 10.1998L4.06545 9.17957C4.43187 8.84591 4.62788 8.37265 4.60643 7.87463L4.54087 6.35315C4.48978 5.16776 5.4893 4.16824 6.67469 4.21933L8.19617 4.28489C8.69419 4.30634 9.16745 4.11033 9.50111 3.74391L10.5213 2.62368Z" fill="#00BAFF"/><path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </div>
          </div>
          <div class="brand-text">
              <span class="channel-name">Code Web Không Khó</span>
              <span class="brand-tagline">Official Demo System</span>
          </div>
      </div>
      <div class="brand-right">
          <span class="status-badge">Secure Payment</span>
      </div>
  </div>

    <h1 class="main-title">Cổng Thanh Toán MoMo (Demo)</h1>

    <div class="card">
      <div class="input-group">
          <label for="amount">Số tiền thanh toán</label>
          <div class="input-wrapper">
              <input id="amount" type="text" inputmode="numeric" value="15,000" />
              <span class="currency-symbol">VND</span>
          </div>
          <div class="input-helper">Tối thiểu 1,000 VND</div>
      </div>

      <div class="input-group">
          <label for="orderInfo">Nội dung thanh toán</label>
          <input id="orderInfo" type="text" value="Thanh toan demo SV" />
      </div>
      
      <button id="payBtn" class="btn-pay">
        <span class="spinner"></span>
        <span class="btn-text">Thanh toán bằng MoMo</span>
      </button>
      
      <p id="status"></p>
    </div>

    <div class="info-box">
      <h4>Hướng dẫn trải nghiệm:</h4>
      <ul>
        <li>Hệ thống sẽ chuyển hướng đến trang thanh toán của <strong>MoMo</strong>.</li>
        <li>Bạn có thể quét mã QR hoặc dùng App MoMo để hoàn tất.</li>
      </ul>
    </div>

    <div class="debug-container">
        <details class="debug-details">
            <summary class="debug-summary">Xem phản hồi kỹ thuật (Debug API)</summary>
            <div class="debug-content">
                <pre id="debugBox">// Chờ dữ liệu từ API...</pre>
            </div>
        </details>
    </div>
  </div>

  <script>
    const payBtn = document.getElementById('payBtn');
    const statusEl = document.getElementById('status');
    const debugBox = document.getElementById('debugBox');
    const amountInput = document.getElementById('amount');

    // Format tiền tệ khi gõ
    amountInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value) {
            e.target.value = parseInt(value, 10).toLocaleString('en-US');
        } else {
            e.target.value = '';
        }
    });

    payBtn.addEventListener('click', async () => {
      statusEl.textContent = '';
      statusEl.className = '';
      
      const rawAmount = amountInput.value.replace(/,/g, '');
      const amountInt = parseInt(rawAmount, 10);

      if (isNaN(amountInt) || amountInt < 1000) {
          statusEl.textContent = '⚠️ Số tiền tối thiểu là 1,000 VND';
          statusEl.className = 'status-error';
          return;
      }

      payBtn.classList.add('loading');
      payBtn.disabled = true;
      payBtn.querySelector('.btn-text').textContent = 'Đang tạo đơn...';

      try {
        const resp = await fetch('/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amountInt.toString(), orderInfo: document.getElementById('orderInfo').value })
        });
        const data = await resp.json();
        debugBox.textContent = JSON.stringify(data, null, 2);

        if (!data.ok) {
          statusEl.textContent = '❌ Lỗi: ' + (data.error?.message || 'Không xác định');
          statusEl.className = 'status-error';
          resetBtn();
          return;
        }

        statusEl.textContent = '✅ Thành công! Đang chuyển hướng...';
        statusEl.className = 'status-success';

        const payUrl = data.momo?.payUrl || (data.momo?.data && data.momo.data.payUrl);
        if (payUrl) {
            setTimeout(() => window.location.href = payUrl, 800);
        } else {
            statusEl.textContent = '⚠️ Không tìm thấy link thanh toán.';
            resetBtn();
        }

      } catch (err) {
        statusEl.textContent = '❌ Lỗi kết nối server.';
        statusEl.className = 'status-error';
        resetBtn();
      }
    });

    function resetBtn() {
        payBtn.classList.remove('loading');
        payBtn.disabled = false;
        payBtn.querySelector('.btn-text').textContent = 'Thanh toán bằng MoMo';
    }
  </script>
</body>
</html>